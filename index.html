<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="author" content="RaoMing" />
  <title>Remote Control - by pharaoh.cnblogs.com</title>
</head>

<body>

  <!-- <input id="url" /><button id="go">GO</button>

<button id = 'btngetImg' onclick='getImg();'>GetImage</button> -->
<!--   <input id='txtKey' />
  <button onclick="sendKey();">send key</button> -->
  <input type="number" min="12141" max="12144" value="12141" id="remoteport" onchange="portchanged()" />
  <button onclick="getImg();">RefreshImage</button>
<!--   <button onclick="window.location = '/';">Main</button> -->
  <button onclick="CloseWin();">Close</button>
  <span id='imgtime'></span>
  <span id='result'></span>
  <!--<iframe id='result' src="about:blank" style='width:500px;height:32px;'></iframe>-->
  <br />
  <img id='screenimg' alt="img" oncontextmenu='imgRClick();return false;' onclick='imgClick();' />

  <div id="msgdiv" style="position:fixed;right:2px;top:3px;background-color:rgba(31,255,0,0.44);z-index:100"></div>

  <script type="text/javascript">
  function getUrl(url, fn, errorfn) {
      var req = new XMLHttpRequest();
      req.open("GET", url, true);
      console.debug("getUrl:", url);
      req.onreadystatechange = function() {
          if (req.readyState == 4) {
              if (req.status == 200) {
                  if (fn) fn(req.responseText);
                  req = null;
              } else {
                  if (errorfn) errorfn(req.responseText, req.status);
                  req = null;
              }
          }
      };
      req.send(null);
  }

    function portchanged () {
        port = parseInt(document.getElementById('remoteport').value,10);
    }

  var port = 12144;
  var imgid = 0;

  var divmsg = document.getElementById('msgdiv');
  var msgtimeid = 0;
  var imgscreen=document.getElementById('screenimg');
  portchanged();
  function checkimage() {
    console.info("checkimage");
    var urlcheck = "http://tank365.duapp.com/getimg/" + port + "/" + imgid;
    getUrl(urlcheck, checkimg_ok, checkimg_error)
  }
  checkimage();

  function checkimg_ok (d) {
      try {
        var js = JSON.parse(d);
        imgid = parseInt(js['tm']);
        tm = new Date(imgid);
        document.getElementById('imgtime').innerText = tm.getHours()+":"+tm.getMinutes()+":"+tm.getSeconds();
        console.timeEnd('getimg');
        imgscreen.src = "http://bcs.duapp.com/publicjs/remotecontrol/" + port + ".jpg" + "?t=" + (+new Date());
      } catch (ex) {
        console.warn("getimg error");
      }
      checkimage();
  }

  function checkimg_error (txt,code) {
      console.info("checkimg_error", code);
      checkimage();
  }

  function setmsg(msg) {
    divmsg.innerText = msg;
    divmsg.style.display = 'block';
    if (msgtimeid > 0) {
      clearTimeout(msgtimeid);
      msgtimeid = 0;
    }
    msgtimeid = setTimeout(function() {
      divmsg.style.display = 'none';
      msgtimeid = 0;
    }, 2000);

  }

  function loadUrl(cmds) {
    var cmd = cmds.cmd;
    setmsg(cmd);
    var query = [];
    cmds.port = port;
    cmds.tmp = +new Date();
    for (var key in cmds) {
      query.push(key + "=" + cmds[key]);
    }
    var url = "http://tank365.duapp.com/sendcmd?" + query.join('&');
    document.getElementById('result').innerText = cmd;
    if(cmd=="getimg") {
        console.time('getimg');
        document.getElementById('imgtime').innerText="get...";
    }
    getUrl(url, function(d) {
      document.getElementById('result').innerText = "ok";
    });
  }

  function CloseWin() {
    if (confirm("确定要关闭远程窗口?")) {
      loadUrl({
        'cmd': 'exit'
      })
      //loadUrl("?cmd=exit&r=" + new Date());
    }
  }

  function getImg() {
    //loadUrl("?cmd=getimg&r=" + new Date());
    //document.getElementById('screenimg').src = "?cmd=getimg&r=" + new Date();
    loadUrl({
      "cmd": "getimg"
    });
  }

  function imgClick(e) {
    loadUrl({
      "cmd": "click",
      "x": window.event.offsetX,
      "y": window.event.offsetY
    });
    window.setTimeout(getImg, 1000);
  }

  function imgRClick(e) {
    setmsg('rclick');
    //loadUrl("?cmd=rclick&x=" + window.event.offsetX + "&y=" + window.event.offsetY);
    loadUrl({
      "cmd": "rclick",
      "x": window.event.offsetX,
      "y": window.event.offsetY
    });
    window.setTimeout(getImg, 500);
  }

  function sendKey() {
    loadUrl({
      'cmd': 'key',
      'key': document.getElementById('txtKey').value
    });

  }
  //getImg();
  </script>

</body>

</html>
